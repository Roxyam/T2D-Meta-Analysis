---
title: "03 Análisis exploratorio"
author: "Roxana Andreea Moldovan Moldovan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: false
    toc_float: false
    number_sections: false 
    code_folding: hide
    theme: flatly
    bg: '#FFFFFF'
    fg: '#202020'
    primary: '#90C432'
    secondary: '#2494b5' 
  pdf_document:
    extra_dependencies: "subfig"
linkcolor: blue
urlcolor: blue
citecolor: blue
header-includes:
- \usepackage{subfig}
- \usepackage{float}
fig_caption: yes 
link-citations: TRUE

---


```{r setup, include=FALSE}
centrado = "center"
knitr::opts_chunk$set(echo = TRUE)
doAll = T
loadData = TRUE
doBP = F
doPCA = F
doClus = F
doBar = F
doBatch = F
doShow = T
doAnot = T
doAnot2 = T
doBEC = F 
doRes = F 
```  

```{r echo=T, eval=TRUE, message=FALSE, warning=FALSE}
library(pacman)
pacman::p_load(affy)
pacman::p_load(DT)
pacman::p_load(ggplot2)
pacman::p_load(ggpubr)
pacman::p_load(glue) 
pacman::p_load(SummarizedExperiment)
pacman::p_load(sva)
pacman::p_load(flextable)
pacman::p_load(officer)
pacman::p_load(dplyr)
pacman::p_load(ComplexHeatmap)
pacman::p_load(ComplexUpset)
pacman::p_load(plyr)
pacman::p_load(stringr)

## Parametros
DirBase = "/home/rmoldovan/Metaanalisis"
DirBase = "C:/Users/roxya/OneDrive/Documentos/01Master_bioinformatica/00TFM/Met_sn"
DirData = glue("{DirBase}/Data")
DirPlots =  glue("{DirBase}/Plots")

## Carga de funciones
source(glue("{DirBase}/02Scripts/Functions.R"))

colors = c("Np_IS" = "#90C432", "Np_IR" = "#884EA0" , "Ob_IS"= "#2494B5", "Ob_IR" = "#D8609A")
alpha = c("M" = 0.95, "F" = 0.45)
alpha0 = c("M" = 0.65, "F" = 0.25)
forma = c(16,17)
```


#    {.tabset .tabset-fade -}  

&nbsp;   
&nbsp;  

## Información  general {.tabset .tabset-fade -}   

&nbsp;  

Este script permite la exploración y representación de los datos de los estudios 
seleccionados. 
Los datos brutos se han descargado de GEO y de ArrayExpress, los datos de imagen 
de miroarrays se han convertidos a conteos sin normalizar.   

Dada la variabilidad de la información, los estudios se ha unificado bajo los
siguientes criterios, atendiendo a dichas características y tomándose los 
niveles presentes a ese en función del experimento:   

* Identificador de la muestra:   
Nombre asignado a la muestra según una numeración ascendente sencilla.   

```
- Sample:  

Niveles : S1...Sn
```  

* Diabetes:   
Condición médica que categoriza al paciente en función de la respuesta a la 
insulina y la presencia de DM2.   

```
- Diabetes: 

  · IS: "Insulin Sensitive" (sensible a insulina o control)
  · IR: "Insulin resitence" (resistente a insulina o diabético)

Niveles : IS, IR
```   

* Obesidad:   
condición que categoriza al paciente respecto a la obesidad. Se define en
función del BMI, para este estudio en todos los casos se ha fijado un límite
de 30kg/m2 en base a los criterios médicos previamente definidos y documentados.   

```
- Obesity: 

  · Np: Normopeso (BMI > 30kg/m2).
  · Ob: Obeso (BMI >= 30kg/m2).

Niveles : Np, Ob
```   

* Grupo  
se define como la combinación del estado del paciente ante la obesidad y la 
resistencia a la insulina, lo que facilita el análisis y la comparación de 
diferentes subgrupos dentro de este. En este análisis se establecen tres niveles
obtenidos mediante la combinación lineal de las dos variables anteriores y 
repartidos entre los distintos estudios.   

```
- Group: 

Niveles : Np_IS, Ob_IS, Ob_IR
```    

* Sexo:    
Condición que representa el sexo del paciente de proveniencia de la nuestra.    

```
- Gender: 

  · M: "Male" (hombre).
  · F: "Female" (mujer).

Niveles : M, F
```    

* Tejido:    
Clasificación detallada del tejido de origen de la muestra. Según la procedencia 
de la muestra y las diferencias clínicas y fisiológicas previamente descritas 
entre los distintos tejidos y su disposición, se han definido dos grupos
clínicamente relevantes: SAT y VAT.   

```
- Tissue: 

  · SAT: Subcutaneous Adipose Tissue (tejido adiposo subcutáneo)
  · VAT: Visceral Adipose Tissue (tejido adiposo visceral) 

Niveles : SAT, VAT
```   

* Grupo de edad:    
Clasificación de los pacientes en función del rango de edad. Dada la prevalencia
e importancia de la DM2 a edades avanzadas y las diferencias a nivel metabólico
y hormonal, propias de la edad y el desarrollo, se han separado a los pacientes
en dos grupos. 

```
- AgeGroup: 

  · Adult: Adulto.
  · Non adult: Menores de 18 años. 

Niveles : Adult, Non adult
```    

* Identificador del paciente:    
Código identificador asignado a cada muestra según el paciente de proveniencia. 
En caso de que dos o más muestras provengan de un mismo paciente estas presentan
el mismo identificador.    

```
- Patient:  

Niveles : P1...Pn
```    

Tras unificar la información de los estudios estos se han procesado y
guardado en objetos de la clase SummarizedExperiment y ExpressionSet.   

&nbsp;  

***      

&nbsp;   



## Análisis exploratorio  {.tabset .tabset-fade -}   


### E-MEXP-1425 {.tabset .tabset-fade -}    

&nbsp;   

Estudio transcriptómico mediante microarrays empleando la plataforma Affymetrix 
GeneChip Human Genome U133 Plus 2.0 [HG-U133_Plus_2].  

Dicho estudio pretende  elucidar los perfiles transcriptómicos de la obesidad,
en base a un diseño experimental de “controles clonales”. Para ello se emplearon
muestras de a SAT de doce parejas de gemelos homocigotos y una de trillizos con
obesidad discordante y con una diferencia de BMI>3kg/m2.  


```{r echo=TRUE, results = "hide", eval=loadData, message=FALSE, warning=FALSE}
# Información y definición de parámetros
Acc = "E_MEXP_1425"
DirrawData = paste(DirData, Acc, "01rawData", sep = "/")
DirRData = paste(DirData, Acc, "02RData", sep = "/")
DirPlot = glue("{DirPlots}/{Acc}")

# Creamos el directorio para almacenar los plots
system(glue("mkdir {DirPlot}"))

# Cargamos los datos 
E_MEXP_1425_rawData = rawData = get(load(glue("{DirRData}/rawData.RData")))
E_MEXP_1425_normData = normData = get(load(glue("{DirRData}/normData2.RData")))
E_MEXP_1425_finalData = finalData = get(load(glue("{DirRData}/finalData.RData")))

# Datos fenotípicos
phenoData = data.frame(RX_ifelse(class(finalData) == "SummarizedExperiment",
                                colData(finalData),
                                pData(finalData)))
# Parámetros
color = colors[levels(phenoData$Group)] # Colores
nTis = length(levels(phenoData$Tissue)) # Número de tejidos distintos
nSTis = max(table(phenoData$Tissue))    # Número máximo de muestras por tejido

# Color
color = colors[levels(phenoData$Group)] 
```  

&nbsp;

#### Resumen {-}     


```{r echo=T, eval=doBar, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  E_MEXP_1425 por grupo y sexo._"}  

BarPlot <- RX_resumeBarPlot(phenoData,
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = FALSE,
                            alpha = alpha0,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.5 + (0.1*nTis)) +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(expand = c(0.2, 0.2))

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}ResumeBarPlot.svg"),
       height = 3.5, 
       width = 4 + (2*nTis)) # Dim

BarPlot 
```  


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  E_MEXP_1425 por grupo y sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}ResumeBarPlot.svg"))

```  


&nbsp;   

***      

&nbsp;  


#### Datos crudos {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}rawBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(rawData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(rawData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(rawData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.4,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}rawHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    



#### Datos normalizados {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(normData) == "SummarizedExperiment",
                       assay(normData),
                       exprs(normData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.4,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normHC.svg"))

``` 

&nbsp;   

***      

&nbsp;     

#### Datos finales (normalizados y anotados) {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(finalData) == "SummarizedExperiment",
                       assay(finalData),
                       exprs(finalData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}finalBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(finalData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(finalData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(finalData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.4,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}finalHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio E-MEXP-1425, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


### GSE2508 {.tabset .tabset-fade -}    

&nbsp;   

Estudio transcriptómico mediante arrays empleando las plataformas:  
* [HG_U95A] Affymetrix Human Genome U95A Array.  
* [HG_U95B] Affymetrix Human Genome U95B Array.  
* [HG_U95C] Affymetrix Human Genome U95C Array.  
* [HG_U95D] Affymetrix Human Genome U95D Array.  
* [HG_U95E] Affymetrix Human Genome U95E Array.  
* [HG_U95Av2] Affymetrix Human Genome U95 Version 2 Array.  

Dicho estudio pretende estudiar los perfiles transcriptómicos diferenciales
entre pacientes sanos, no resistentes a insulina, 20 obesos y 19 con peso
normal a partir de adipocitos provenientes del tejido adiposo subcutáneo
abdominal, considerando obesos los pacientes que presentan un BMI mayor o
igual a 30kg/m2.   


```{r echo=TRUE, results = "hide", eval=loadData, message=FALSE, warning=FALSE}
# Información y definición de parámetros
Acc = "GSE2508"
DirrawData = paste(DirData, Acc, "01rawData", sep = "/")
DirRData = paste(DirData, Acc, "02RData", sep = "/")
DirPlot = glue("{DirPlots}/{Acc}")

# Creamos el directorio para almacenar los plots
system(glue("mkdir {DirPlot}"))

# Cargamos los datos 
GSE2508_rawData = GSE2508_normData = normData= get(load(glue("{DirRData}/normData.RData")))
GSE2508_normData2 = normData2= get(load(glue("{DirRData}/normData2.RData")))
GSE2508_finalData = finalData = get(load(glue("{DirRData}/finalData.RData")))

# Datos fenotípicos
phenoData = data.frame(RX_ifelse(class(finalData) == "SummarizedExperiment",
                                colData(finalData),
                                pData(finalData)))
# Parámetros
color = colors[levels(phenoData$Group)] # Colores
nTis = length(levels(phenoData$Tissue)) # Número de tejidos distintos
nSTis = max(table(phenoData$Tissue))    # Número máximo de muestras por tejido

# Color
color = colors[levels(phenoData$Group)]  
```  


&nbsp;    

#### Resumen {-}     



```{r echo=T, eval=doBar, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE2508 por grupo y sexo._"}  

BarPlot <- RX_resumeBarPlot(phenoData,
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = FALSE,
                            alpha = alpha0,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.5 + (0.1*nTis)) +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(expand = c(0.2, 0.2))

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}ResumeBarPlot.svg"),
       height = 3.5, 
       width = 4 + (2*nTis)) # Dim

BarPlot 

```  


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE2508 por grupo y sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}ResumeBarPlot.svg"))

```  


&nbsp;   

***      

&nbsp;  


#### Datos normalizados {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(normData) == "SummarizedExperiment",
                       assay(normData),
                       exprs(normData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  



##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.25,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Batch effect {.tabset .tabset-fade -}   

Estudiamos las posibles variables que produzca batch effect.  


```{r echo=T, eval=doBatch, message=FALSE, warning=FALSE}
# Creamos la variable que indique si son muestras nuevas o reanalizadas  
batchVar = phenoData$Batch 
ColorList = c("#00AFBB", "#CB326D")
ColorPal <- colorRampPalette(ColorList)
colorsBath <- ColorPal(length(levels(batchVar)))
```


&nbsp;       


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE2508, atendiendo al batch effect._"}
### PCA
# Computar la PCA 
PCAplot = RX_multiplotPCA(normData,
                          multiplot = FALSE, 
                          labels = "Sample",
                          colorColumn = "Batch",
                          shapeColumn = "Gender",
                          shapes = forma,
                          colors = colorsBath,
                          colorLegend = "Batch",
                          shapeLegend = "Sexo",
                          alpha = 0.8) 

# Guardamos
ggsave(PCAplot, device = "svg",
       filename = glue("{DirPlot}/{Acc}BatchPCA0.svg"),
       height = 6, width = 8) 
  
PCAplot
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE2508, atendiendo al batch effect._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}BatchPCA0.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Batch",
                            colorPal = colorsBath,
                            colorOutColumn = "Batch",
                            colorOutPal = colorsBath,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Batch",
                         colorPal = colorsBath,
                         colorOutColumn = "Batch",
                         colorOutPal = colorsBath,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.25,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}BatchHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 

knitr::include_graphics(glue("{DirPlot}/{Acc}BatchHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Corrección del batch effect {.tabset .tabset-fade -}   

Corregimos en batch effect. 

&nbsp;    

##### Boxplot {-}   


```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
# Expresión 
expressData =RX_ifelse(class(normData2) == "SummarizedExperiment",
                       assay(normData2),
                       exprs(normData2))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normNoBatchBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```     


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Análsisis de comopnentes principales del estudio GSE2508,atendiendo al batch effect._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchBoxPlot.svg"))

``` 



##### PCA {.tabset .tabset-fade -}     
  
###### Exp var {-}    

```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData2,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo")
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
} else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData2,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData2,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                   common.legend = TRUE,
                                   legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 


    
```   

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchPCA.svg"))

``` 

&nbsp;   

***      

&nbsp;   


###### Batch var {-}     

```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análsisis de comopnentes principales del estudio GSE2508,atendiendo al batch effect._"}
### PCA
# Computar la PCA 
PCAplot = RX_multiplotPCA(normData2,
                          multiplot = FALSE,
                          labels = "Sample", 
                          colorColumn = "Batch",
                          shapeColumn = "Gender",
                          shapes = forma,
                          colors = colorsBath,
                          colorLegend = "Batch",
                          shapeLegend = "Sexo",
                          alpha = 0.8) 

# Guardamos
ggsave(PCAplot, device = "svg",
       filename = glue("{DirPlot}/{Acc}BatchCorrPCA0.svg"),
       height = 6, width = 8) 
  
PCAplot
    
```    

&nbsp;    

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análsisis de comopnentes principales del estudio GSE2508,atendiendo al batch effect._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}BatchCorrPCA0.svg"))

```  


&nbsp;    

***     

&nbsp;  


##### Clustering  {.tabset .tabset-fade -}      

###### Exp var {-} 

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea

EU_dist = RX_multiplotDendo(normData2,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Group",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            )  

# Por correlación
Corr = RX_multiplotDendo(normData2,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Group",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )   

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.25,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normNoBatchHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchHC.svg"))

```

&nbsp;   

***      

&nbsp;   


###### Batch var {-}     


```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData2,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Batch",
                            colorPal = colorsBath,
                            colorOutColumn = "Batch",
                            colorOutPal = colorsBath,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Group",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            )  

# Por correlación
Corr = RX_multiplotDendo(normData2,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Batch",
                         colorPal = colorsBath,
                         colorOutColumn = "Batch",
                         colorOutPal = colorsBath,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Group",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )   

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.25,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}BatchCorrHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```     

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9  , fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
  
knitr::include_graphics(glue("{DirPlot}/{Acc}BatchCorrHC.svg"))

```


&nbsp;   

***      

&nbsp; 


#### Datos finales (normalizados y anotados) {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(finalData) == "SummarizedExperiment",
                       assay(finalData),
                       exprs(finalData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}finalBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(finalData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(finalData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(finalData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.25,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}finalHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=9, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE2508, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    



### GSE20950 {.tabset .tabset-fade -}    

&nbsp;  

Estudio transcriptómico mediante arrays empleando la plataforma [HG-U133_Plus_2] 
Affymetrix Human Genome U133 Plus 2.0 Array (GPL570).   

Dicho estudio pone de manifiesto la obesidad como factor de riesgo en el
desarrollo de enfermedades y trastornos metabólicos, más exactamente en el
desarrollo de resistencia a insulina, paro lo que se han analizado los perfiles
de expresión de pacientes obesos resistentes y sensibles a insulina a partir de
muestras de tejido subcutáneo adiposos abdominal (SAT) y omental (VAT) de 20
pacientes adultos, con una media de edad de 42 años. 


```{r echo=TRUE, results = "hide", eval=loadData, message=FALSE, warning=FALSE}
# Información y definición de parámetros
Acc = "GSE20950"
DirrawData = paste(DirData, Acc, "01rawData", sep = "/")
DirRData = paste(DirData, Acc, "02RData", sep = "/")
DirPlot = glue("{DirPlots}/{Acc}")

# Creamos el directorio para almacenar los plots
system(glue("mkdir {DirPlot}"))

# Cargamos los datos 
GSE20950_rawData = rawData = get(load(glue("{DirRData}/rawData.RData")))
GSE20950_normData = normData= get(load(glue("{DirRData}/normData.RData")))
GSE20950_normData2 = normData2= get(load(glue("{DirRData}/normData2.RData")))
GSE20950_finalData = finalData = get(load(glue("{DirRData}/finalData.RData")))

# Datos fenotípicos
phenoData = data.frame(RX_ifelse(class(finalData) == "SummarizedExperiment",
                                colData(finalData),
                                pData(finalData)))
# Parámetros
color = colors[levels(phenoData$Group)] # Colores
nTis = length(levels(phenoData$Tissue)) # Número de tejidos distintos
nSTis = max(table(phenoData$Tissue))    # Número máximo de muestras por tejido

# Color
color = colors[levels(phenoData$Group)] 

```  


&nbsp;    

#### Resumen {-}     


```{r echo=T, eval=doBar, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=10, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE20950 por grupo y sexo._"}  

BarPlot <- RX_resumeBarPlot(phenoData,
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = FALSE,
                            alpha = alpha0,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.5 + (0.1*nTis)) +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(expand = c(0.2, 0.2))

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}ResumeBarPlot.svg"),
       height = 3.5, 
       width = 4 + (2*nTis)) # Dim

BarPlot 

```  


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=10, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE20950 por grupo y sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}ResumeBarPlot.svg"))

```  


&nbsp;   

***      

&nbsp;  



#### Datos crudos {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 
BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha,
                     dir = "h")

ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}rawBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    

```{r echo=F, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 
BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha,
                     dir = "v",
                     ncol = 2)

# Guardamos
ggsave(BoxPlot, device = "png",
       filename = glue("{DirPlot}/{Acc}rawBoxPlotTFM.png"),
       height =  4, #2 + (3*round(nTis/2)),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
#BoxPlot
```    

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(rawData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(rawData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(rawData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.50,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}rawHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Datos normalizados {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(normData) == "SummarizedExperiment",
                       assay(normData),
                       exprs(normData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    



```{r echo=F, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(normData) == "SummarizedExperiment",
                       assay(normData),
                       exprs(normData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha,
                     dir = "v",
                     ncol = 2)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normBoxPlotTFM.svg"),
       height =  4, #2 + (3*round(nTis/2)),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
#BoxPlot
```   

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.50,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Batch effect {.tabset .tabset-fade -}   

Estudiamos las posibles variables que produzca batch effect.  


```{r echo=T, eval=doBatch, message=FALSE, warning=FALSE}
# Creamos la variable que indique si son muestras nuevas o reanalizadas  
batchVar = phenoData$Batch 
ColorList = c("#00AFBB", "#CB326D")
ColorPal <- colorRampPalette(ColorList)
colorsBath <- ColorPal(length(levels(batchVar)))
```


&nbsp;       


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, atendiendo al batch effect._"}
### PCA
# Computar la PCA 
PCAplot = RX_multiplotPCA(normData,
                          multiplot = FALSE, 
                          labels = "Sample",
                          colorColumn = "Batch",
                          shapeColumn = "Gender",
                          shapes = forma,
                          colors = colorsBath,
                          colorLegend = "Batch",
                          shapeLegend = "Sexo",
                          alpha = 0.8) 

# Guardamos
ggsave(PCAplot, device = "svg",
       filename = glue("{DirPlot}/{Acc}BatchPCA0.svg"),
       height = 6, width = 8) 
  
PCAplot
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, atendiendo al batch effect._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}BatchPCA0.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Batch",
                            colorPal = colorsBath,
                            colorOutColumn = "Batch",
                            colorOutPal = colorsBath,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Batch",
                         colorPal = colorsBath,
                         colorOutColumn = "Batch",
                         colorOutPal = colorsBath,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.50,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}BatchHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
knitr::include_graphics(glue("{DirPlot}/{Acc}BatchHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Corrección del batch effect {.tabset .tabset-fade -}   

Corregimos en batch effect. 

&nbsp;    

##### Boxplot {-}   


```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
# Expresión 
expressData =RX_ifelse(class(normData2) == "SummarizedExperiment",
                       assay(normData2),
                       exprs(normData2))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normNoBatchBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```     


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Análsisis de componentes principales del estudio GSE20950,atendiendo al batch effect._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchBoxPlot.svg"))

``` 



##### PCA {.tabset .tabset-fade -}     
  
###### Exp var {-}    

```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData2,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo")
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
} else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData2,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData2,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                   common.legend = TRUE,
                                   legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
  } 
    
```   

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchPCA.svg"))

``` 

&nbsp;   

***      

&nbsp;   


###### Batch var {-}     

```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análsisis de componentes principales del estudio GSE20950,atendiendo al batch effect._"}
### PCA
# Computar la PCA 
PCAplot = RX_multiplotPCA(normData2,
                          multiplot = FALSE,
                          labels = "Sample",
                          colorColumn = "Batch",
                          shapeColumn = "Gender",
                          shapes = forma,
                          colors = colorsBath,
                          colorLegend = "Batch",
                          shapeLegend = "Sexo",
                          alpha = 0.8) 

# Guardamos
ggsave(PCAplot, device = "svg",
       filename = glue("{DirPlot}/{Acc}BatchCorrPCA0.svg"),
       height = 6, width = 8) 
  
PCAplot
    
```    

&nbsp;    

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análsisis de componentes principales del estudio GSE20950,atendiendo al batch effect._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}BatchCorrPCA0.svg"))

```  


&nbsp;    

***     

&nbsp;  


##### Clustering  {.tabset .tabset-fade -}      

###### Exp var {-} 

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea

EU_dist = RX_multiplotDendo(normData2,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Group",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            )  

# Por correlación
Corr = RX_multiplotDendo(normData2,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Group",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )   

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.50,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normNoBatchHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchHC.svg"))

```

&nbsp;   

***      

&nbsp;   


###### Batch var {-}     


```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData2,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Batch",
                            colorPal = colorsBath,
                            colorOutColumn = "Batch",
                            colorOutPal = colorsBath,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Group",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            )  

# Por correlación
Corr = RX_multiplotDendo(normData2,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Batch",
                         colorPal = colorsBath,
                         colorOutColumn = "Batch",
                         colorOutPal = colorsBath,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Group",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )   

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.50,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}BatchCorrHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```     

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
  
knitr::include_graphics(glue("{DirPlot}/{Acc}BatchCorrHC.svg"))

```


&nbsp;   

***      

&nbsp; 


#### Datos finales (normalizados y anotados) {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(finalData) == "SummarizedExperiment",
                       assay(finalData),
                       exprs(finalData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}finalBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(finalData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(finalData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(finalData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.50,10,0.0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}finalHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=10, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE20950, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    




### GSE29718 {.tabset .tabset-fade -}    

&nbsp;  

Estudio transcriptómico mediante arrays empleando la plataforma [HuGene-1_0-st]
Affymetrix Human Gene 1.0 ST Array [transcript (gene) version] (GPL6244).  

En un intento de elucidad los mecanismos genéticos que están detrás de la
obesidad,y que posteriormente podrías conducir al desarrollo de diabetes de
tipo 2, este estudio pretende estudiar las diferencias entre niños obesos, con
el objetivo de minimizar los efectos de la pubertad.  
Para ello se han tomado 15 muestras de tejido adiposo subcutáneo abdominal (SAT)
y 5 de visceral (VAT) pertenecientes a niños con edades menores de 9 años.   


```{r echo=TRUE, results = "hide", eval=loadData, message=FALSE, warning=FALSE}
# Información y definición de parámetros
Acc = "GSE29718"
DirrawData = paste(DirData, Acc, "01rawData", sep = "/")
DirRData = paste(DirData, Acc, "02RData", sep = "/")
DirPlot = glue("{DirPlots}/{Acc}")

# Creamos el directorio para almacenar los plots
system(glue("mkdir {DirPlot}"))

# Cargamos los datos 
GSE29718_rawData = rawData = get(load(glue("{DirRData}/rawData.RData")))
GSE29718_normData = normData= get(load(glue("{DirRData}/normData.RData")))
GSE29718_normData2 = normData2= get(load(glue("{DirRData}/normData2.RData")))
GSE29718_finalData = finalData = get(load(glue("{DirRData}/finalData.RData")))

# Datos fenotípicos
phenoData = data.frame(RX_ifelse(class(finalData) == "SummarizedExperiment",
                                colData(finalData),
                                pData(finalData)))
# Parámetros
color = colors[levels(phenoData$Group)] # Colores
nTis = length(levels(phenoData$Tissue)) # Número de tejidos distintos
nSTis = max(table(phenoData$Tissue))    # Número máximo de muestras por tejido

# Color
color = colors[levels(phenoData$Group)] 

```  


&nbsp;    

#### Resumen {-}     



```{r echo=T, eval=doBar, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=10, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE29718 por grupo y sexo._"}  

BarPlot <- RX_resumeBarPlot(phenoData,
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = FALSE,
                            alpha = alpha0,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.5 + (0.1*nTis)) +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(expand = c(0.2, 0.2))

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}ResumeBarPlot.svg"),
       height = 3.5, 
       width = 4 + (2*nTis)) # Dim

BarPlot 

```  


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=10, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE29718 por grupo y sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}ResumeBarPlot.svg"))

```  


&nbsp;   

***      

&nbsp;  



#### Datos crudos {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}rawBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 
BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha,
                     dir = "v",
                     ncol = 2)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}rawBoxPlotTFM.svg"),
       height =  4, #2 + (3*round(nTis/2)),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
#BoxPlot
```    

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(rawData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(rawData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(rawData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.7,10,0.1)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}rawHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Datos normalizados {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(normData) == "SummarizedExperiment",
                       assay(normData),
                       exprs(normData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    

```{r echo=F, eval=doBP, message=FALSE,warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(normData) == "SummarizedExperiment",
                       assay(normData),
                       exprs(normData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha,
                     dir = "v",
                     ncol = 2)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normBoxPlotTFM.svg"),
       height =  4, #2 + (3*round(nTis/2)),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
#BoxPlot
```   

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.7,10,0.1)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Batch effect {.tabset .tabset-fade -}   

Estudiamos las posibles variables que produzca batch effect.  


```{r echo=T, eval=doBatch, message=FALSE, warning=FALSE}
# Creamos la variable que indique el batch en el que se ha analizando las muestras
batchVar = phenoData$Batch 
ColorList = c("#00AFBB", "#CB326D")
ColorPal <- colorRampPalette(ColorList)
colorsBath <- ColorPal(length(levels(batchVar)))
```


&nbsp;       


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, atendiendo al batch effect._"}
### PCA
# Computar la PCA 
PCAplot = RX_multiplotPCA(normData,
                          multiplot = FALSE, 
                          labels = "Sample",
                          colorColumn = "Batch",
                          shapeColumn = "Gender",
                          shapes = forma,
                          colors = colorsBath,
                          colorLegend = "Batch",
                          shapeLegend = "Sexo",
                          alpha = 0.8) 

# Guardamos
ggsave(PCAplot, device = "svg",
       filename = glue("{DirPlot}/{Acc}BatchPCA0.svg"),
       height = 6, width = 8) 
  
PCAplot
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, atendiendo al batch effect._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}BatchPCA0.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Batch",
                            colorPal = colorsBath,
                            colorOutColumn = "Batch",
                            colorOutPal = colorsBath,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Batch",
                         colorPal = colorsBath,
                         colorOutColumn = "Batch",
                         colorOutPal = colorsBath,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.7,10,0.1)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}BatchHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
knitr::include_graphics(glue("{DirPlot}/{Acc}BatchHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Corrección del batch effect {.tabset .tabset-fade -}   

Corregimos en batch effect. 

&nbsp;    

##### Boxplot {-}   


```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
# Expresión 
expressData =RX_ifelse(class(normData2) == "SummarizedExperiment",
                       assay(normData2),
                       exprs(normData2))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normNoBatchBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```     


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Análsisis de componentes principales del estudio GSE29718,atendiendo al batch effect._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchBoxPlot.svg"))

``` 



##### PCA {.tabset .tabset-fade -}     
  
###### Exp var {-}    

```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData2,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo")
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
} else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData2,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData2,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                   common.legend = TRUE,
                                   legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normNoBatchPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
  } 
    
```   

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchPCA.svg"))

``` 

&nbsp;   

***      

&nbsp;   


###### Batch var {-}     

```{r echo=T, eval=doBEC, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análsisis de componentes principales del estudio GSE29718,atendiendo al batch effect._"}
### PCA
# Computar la PCA 
PCAplot = RX_multiplotPCA(normData2,
                          multiplot = FALSE,
                          labels = "Sample",
                          colorColumn = "Batch",
                          shapeColumn = "Gender",
                          shapes = forma,
                          colors = colorsBath,
                          colorLegend = "Batch",
                          shapeLegend = "Sexo",
                          alpha = 0.8) #+
  #facet_wrap(facets = c(normData2$Tissue), ncol = 2, scales = "free")

# Guardamos
ggsave(PCAplot, device = "svg",
       filename = glue("{DirPlot}/{Acc}BatchCorrPCA0.svg"),
       height = 6, width = 8) 
  
PCAplot
    
```    

&nbsp;    

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análsisis de componentes principales del estudio GSE29718,atendiendo al batch effect._"}
  
knitr::include_graphics(glue("{DirPlot}/{Acc}BatchCorrPCA0.svg"))

```  


&nbsp;    

***     

&nbsp;  


##### Clustering  {.tabset .tabset-fade -}      

###### Exp var {-} 

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea

EU_dist = RX_multiplotDendo(normData2,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Group",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            )  

# Por correlación
Corr = RX_multiplotDendo(normData2,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Group",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )   

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.7,10,0.1)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normNoBatchHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
  
knitr::include_graphics(glue("{DirPlot}/{Acc}normNoBatchHC.svg"))

```

&nbsp;   

***      

&nbsp;   


###### Batch var {-}     


```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData2,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Batch",
                            colorPal = colorsBath,
                            colorOutColumn = "Batch",
                            colorOutPal = colorsBath,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Group",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            )  

# Por correlación
Corr = RX_multiplotDendo(normData2,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Batch",
                         colorPal = colorsBath,
                         colorOutColumn = "Batch",
                         colorOutPal = colorsBath,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Group",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )   

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.7,10,0.1)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}BatchCorrHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```     

```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su batch effect por colors, mientras que la forma denota el sexo. Este cluster se ha llevado a cabo para cada uno de los tejidos, tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"} 
  
knitr::include_graphics(glue("{DirPlot}/{Acc}BatchCorrHC.svg"))

```


&nbsp;   

***      

&nbsp; 


#### Datos finales (normalizados y anotados) {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(finalData) == "SummarizedExperiment",
                       assay(finalData),
                       exprs(finalData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}finalBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(finalData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=12, fig.width=12, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. *A.* PCA en base a todas las muestras del estudio. *B.*  PCAs individuales para cada uno de los tejidos de proveniencia de las muestras._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(finalData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(finalData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.7,10,0.1)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]],
               EU_dist$Plot[[2]], Con[[2]], Corr$Plot[[2]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 2,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}finalHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=7, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE29718, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


### GSE64567 {.tabset .tabset-fade -}    

&nbsp;  

Estudio transcriptómico mediante arrays empleando la plataforma Illumina
HumanHT-12 V4.0 expression beadchip (GPL10558).

En un intento de elucidar los cambios a nivel transcripcional que conducen al
desarrollo de obesidad y la posible futura asociación entre esta y la diabetes
de tipo 2, en este estudio se tomaron muestras provenientes del tejido
subcutáneo abdominal de 64 sujetos adultos no relacionados, no diabéticos y con
diferentes indices de masa corporal (BMI).   
Partiendo de los datos recopilados en este estudio, basándonos en el BMI, y
tomando como límite 30>= podes separar los sujetos en dos grupos: obesos (n=35)
y control (n=29).


```{r echo=TRUE, results = "hide", eval=loadData, message=FALSE, warning=FALSE}
# Información y definición de parámetros
Acc = "GSE64567"
DirrawData = paste(DirData, Acc, "01rawData", sep = "/")
DirRData = paste(DirData, Acc, "02RData", sep = "/")
DirPlot = glue("{DirPlots}/{Acc}")

# Creamos el directorio para almacenar los plots
system(glue("mkdir {DirPlot}"))

# Cargamos los datos 
GSE64567_rawData = rawData = get(load(glue("{DirRData}/rawData.RData")))
GSE64567_normData = normData= get(load(glue("{DirRData}/normData.RData")))
GSE64567_finalData = finalData = get(load(glue("{DirRData}/finalData.RData")))

# Datos fenotípicos
phenoData = data.frame(RX_ifelse(class(finalData) == "SummarizedExperiment",
                                colData(finalData),
                                pData(finalData)))
# Parámetros
color = colors[levels(phenoData$Group)] # Colores
nTis = length(levels(phenoData$Tissue)) # Número de tejidos distintos
nSTis = max(table(phenoData$Tissue))    # Número máximo de muestras por tejido

# Color
color = colors[levels(phenoData$Group)] 

```  


&nbsp;    

#### Resumen {-}     



```{r echo=T, eval=doBar, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE64567 por grupo y sexo._"}  


BarPlot <- RX_resumeBarPlot(phenoData,
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = FALSE,
                            alpha = alpha0,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.5 + (0.1*nTis)) +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(expand = c(0.2, 0.2))

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}ResumeBarPlot.svg"),
       height = 3.5, 
       width = 4 + (2*nTis)) # Dim

BarPlot 

```  


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE64567 por grupo y sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}ResumeBarPlot.svg"))

```  


&nbsp;   

***      

&nbsp;  



#### Datos crudos {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = "log2",
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}rawBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(rawData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=16, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(rawData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(rawData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.15,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}rawHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=16, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Datos normalizados {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(normData) == "SummarizedExperiment",
                       assay(normData),
                       exprs(normData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=16, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.15,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=16, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Datos finales (normalizados y anotados) {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(finalData) == "SummarizedExperiment",
                       assay(finalData),
                       exprs(finalData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}finalBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(finalData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=16, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(finalData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(finalData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.15,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}finalHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=16, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE64567, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


### GSE92405 {.tabset .tabset-fade -}    

&nbsp;   

Estudio transcriptómico mediante arrays empleando la plataforma Affymetrix
Human Genome U133 Plus 2.0 Array [CDF: Brainarray HGU133Plus2_Hs_ENTREZG_v18].  

Dicho estudio pretende estudiar los perfiles transcriptómicos globales de
parejas de gemelos con índices de masa corporal discordantes (más de 3kg/m2). 
Estos perfiles fueron analizados partiendo de tejido adiposos subcutáneo 
abdominal (SAT).    
  


```{r echo=TRUE, results = "hide", eval=loadData, message=FALSE, warning=FALSE}
# Información y definición de parámetros
Acc = "GSE92405"
DirrawData = paste(DirData, Acc, "01rawData", sep = "/")
DirRData = paste(DirData, Acc, "02RData", sep = "/")
DirPlot = glue("{DirPlots}/{Acc}")

# Creamos el directorio para almacenar los plots
system(glue("mkdir {DirPlot}"))

# Cargamos los datos 
GSE92405_rawData = rawData = get(load(glue("{DirRData}/rawData.RData")))
GSE92405_normData2 = normData2= get(load(glue("{DirRData}/normData2.RData")))
GSE92405_normData = normData= get(load(glue("{DirRData}/normData.RData")))
GSE92405_finalData = finalData = get(load(glue("{DirRData}/finalData.RData")))

# Datos fenotípicos
phenoData = data.frame(RX_ifelse(class(finalData) == "SummarizedExperiment",
                                colData(finalData),
                                pData(finalData)))
# Parámetros
color = colors[levels(phenoData$Group)] # Colores
nTis = length(levels(phenoData$Tissue)) # Número de tejidos distintos
nSTis = max(table(phenoData$Tissue))    # Número máximo de muestras por tejido

# Color
color = colors[levels(phenoData$Group)] 
```  


&nbsp;    

#### Resumen {-}     



```{r echo=T, eval=doBar, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE92405 por grupo y sexo._"}  

BarPlot <- RX_resumeBarPlot(phenoData,
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = FALSE,
                            alpha = alpha0,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.5 + (0.1*nTis)) +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(expand = c(0.2, 0.2))

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}ResumeBarPlot.svg"),
       height = 3.5, 
       width = 4 + (2*nTis)) # Dim

BarPlot 
```  


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE92405 por grupo y sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}ResumeBarPlot.svg"))

```  


&nbsp;   

***      

&nbsp;  



#### Datos crudos {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}rawBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(rawData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=13, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(rawData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(rawData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.15,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}rawHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=13, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Datos normalizados {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(normData) == "SummarizedExperiment",
                       assay(normData),
                       exprs(normData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}normBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(normData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(normData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}normPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=13, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(normData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(normData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.15,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}normHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=13, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}normHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    



#### Datos finales (normalizados y anotados) {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(finalData) == "SummarizedExperiment",
                       assay(finalData),
                       exprs(finalData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = NULL,
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}finalBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** Boxplot del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(finalData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=13, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(finalData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(finalData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.15,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}finalHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=13, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE92405, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


### GSE141432 {.tabset .tabset-fade -}    

&nbsp;   

Estudio transcriptómico mediante secuenciación masiva.  

En este caso se estudia el desarrollo de diabetes de tipo 2 en relación con
la obesidad, para ello se han tomado muestras de tejido adiposo subcutáneo 
abdominal de tres grupos de pacientes, sujetos sanos sin obesidad
(controles, n=9), sujetos sanos obesos (n=8) y sujetos obesos con diabetes
de tipo 2 (n=8).    
  


```{r echo=TRUE, results = "hide", eval=loadData, message=FALSE, warning=FALSE}
# Información y definición de parámetros
Acc = "GSE141432"
DirrawData = paste(DirData, Acc, "01rawData", sep = "/")
DirRData = paste(DirData, Acc, "02RData", sep = "/")
DirPlot = glue("{DirPlots}/{Acc}")

# Creamos el directorio para almacenar los plots
system(glue("mkdir {DirPlot}"))

# Cargamos los datos 
GSE141432_rawData = rawData = get(load(glue("{DirRData}/rawData.RData")))
GSE141432_finalData = finalData = get(load(glue("{DirRData}/finalData.RData")))

# Datos fenotípicos
phenoData = data.frame(RX_ifelse(class(finalData) == "SummarizedExperiment",
                                colData(finalData),
                                pData(finalData)))
# Parámetros
color = colors[levels(phenoData$Group)] # Colores
nTis = length(levels(phenoData$Tissue)) # Número de tejidos distintos
nSTis = max(table(phenoData$Tissue))    # Número máximo de muestras por tejido

# Color
color = colors[levels(phenoData$Group)] 

```  


&nbsp;    

#### Resumen {-}     



```{r echo=T, eval=doBar, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE141432 por grupo y sexo._"}  


BarPlot <- RX_resumeBarPlot(phenoData,
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = FALSE,
                            alpha = alpha0,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.6 + (0.1*nTis)) +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(expand = c(0.2, 0.2))

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}ResumeBarPlot.svg"),
       height = 3.5, 
       width = 4 + (2*nTis)) # Dim

BarPlot 

```  


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE141432 por grupo y sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}ResumeBarPlot.svg"))

```  


&nbsp;   

***      

&nbsp;  



#### Datos crudos {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = "log2",
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}rawBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(rawData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(rawData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(rawData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.4,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}rawHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Datos finales (anotados) {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(finalData) == "SummarizedExperiment",
                       assay(finalData),
                       exprs(finalData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = "log2",
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}finalBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(finalData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(finalData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(finalData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.4,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}finalHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE141432, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


### GSE205668 {.tabset .tabset-fade -}    

&nbsp;   

Estudio transcriptómico mediante secuenciación masiva.   
En este estudio se analizan los patrones de expresión diferencial entre la
obesidad y el peso normal, para ello se tomaron muestras de SAT de 61 sujetos
con edades comprendidas entre 0 y 18 años. Incluyendo muestras control (n=35)
y de obesidad (n=26).   


```{r echo=TRUE, results = "hide", eval=loadData, message=FALSE, warning=FALSE}
# Información y definición de parámetros
Acc = "GSE205668"
DirrawData = paste(DirData, Acc, "01rawData", sep = "/")
DirRData = paste(DirData, Acc, "02RData", sep = "/")
DirPlot = glue("{DirPlots}/{Acc}")

# Creamos el directorio para almacenar los plots
system(glue("mkdir {DirPlot}"))

# Cargamos los datos 
GSE205668_rawData = rawData = get(load(glue("{DirRData}/rawData.RData")))
GSE205668_finalData = finalData = get(load(glue("{DirRData}/finalData.RData")))

# Datos fenotípicos
phenoData = data.frame(RX_ifelse(class(finalData) == "SummarizedExperiment",
                                colData(finalData),
                                pData(finalData)))
# Parámetros
color = colors[levels(phenoData$Group)] # Colores
nTis = length(levels(phenoData$Tissue)) # Número de tejidos distintos
nSTis = max(table(phenoData$Tissue))    # Número máximo de muestras por tejido

# Color
color = colors[levels(phenoData$Group)] 

```  


&nbsp;    

#### Resumen {-}     



```{r echo=T, eval=doBar, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE205668 por grupo y sexo._"}  

BarPlot <- RX_resumeBarPlot(phenoData,
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = FALSE,
                            alpha = alpha0,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.5 + (0.1*nTis)) +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(expand = c(0.2, 0.2))

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}ResumeBarPlot.svg"),
       height = 3.5, 
       width = 4 + (2*nTis)) # Dim

BarPlot 

```  


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Resumen del número de muestras que componen el estudio  GSE205668 por grupo y sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}ResumeBarPlot.svg"))

```  


&nbsp;   

***      

&nbsp;  



#### Datos crudos {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(rawData) == "SummarizedExperiment",
                       assay(rawData),
                       exprs(rawData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = "log2",
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}rawBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(rawData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(rawData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}rawPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=15, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(rawData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(rawData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.15,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}rawHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}rawHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    


#### Datos finales (anotados) {.tabset .tabset-fade -}    

&nbsp;    

##### Boxplot {-}    

```{r echo=T, eval=doBP, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}
# Expresión 
expressData =RX_ifelse(class(finalData) == "SummarizedExperiment",
                       assay(finalData),
                       exprs(finalData))

# Convertimos el objeto al formato deseado
BoxPlotData = RX_dataforboxplot(expressData, 
                                transformacion = "log2",
                                phenoData = phenoData,
                                ncol = "Sample") 

BoxPlot = RX_BoxPlot(Data = BoxPlotData,
                     Fac_fill = "Group",
                     Fac_alpha = "Gender",
                     colors = colors,
                     alpha = alpha)

# Guardamos
ggsave(BoxPlot, device = "svg",
       filename = glue("{DirPlot}/{Acc}finalBoxPlot.svg"),
       height =  2 + (3*nTis),
       width = RX_ifelse(nSTis < 50, 8, 12))

# Mostramos
BoxPlot
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=5, fig.width=8, fig.cap=" _**Figura :** Boxplot del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el género._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalBoxPlot.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### PCA {-}  



```{r echo=T, eval=doPCA, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}
### PCA
# Computar la PCA 
if(length(levels(phenoData$Tissue)) == 1){ # Una PCA global
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6, width = 8) 
  
  PCAplot
  
}  else{ # Tanto global como por tejidos
  # PCA total
  PCAplot = RX_multiplotPCA(finalData,
                            multiplot = FALSE, 
                            factor = "Tissue",
                            labels = "Sample",
                            colorColumn = "Group",
                            shapeColumn = "Gender",
                            shapes = forma,
                            colors = colors,
                            colorLegend = "Grupo",
                            shapeLegend = "Sexo") 
  
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA1.svg"),
         height = 6, width = 12)  
  
  # PCA por cada tejido
  PCAplots = RX_multiplotPCA(finalData,
                             multiplot = TRUE,
                             factor = "Tissue",
                             labels = "Sample",
                             colorColumn = "Group",
                             shapeColumn = "Gender",
                             shapes = forma,
                             colors = colors,
                             colorLegend = "Grupo",
                             shapeLegend = "Sexo")
  # Combinamos
  PCAplot2 = do.call("ggarrange", c(PCAplots,
                                    common.legend = TRUE,
                                    legend = "right"))
  # Guardamos 
  ggsave(PCAplot2, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA2.svg"),
         height = 6, width = 12)  
  
  PCAplot = do.call("ggarrange", c(list(PCAplot, PCAplot2),
                                   nrow = 2,
                                   common.legend = FALSE,
                                   legend = "right",
                                   labels = "AUTO"))
  # Number of lines
  nlines = round(nTis/2) * 2
  # Guardamos
  ggsave(PCAplot, device = "svg",
         filename = glue("{DirPlot}/{Acc}finalPCA.svg"),
         height = 6*nlines, width = 12) 
  
  # Mostramos
  PCAplot
} 
    
```   


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=8, fig.cap=" _**Figura :** Análisis de componentes principales del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalPCA.svg"))

``` 


&nbsp;   

***      

&nbsp;  


##### Clustering {-}       

```{r echo=T, eval=doClus, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=15, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este clustering se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}
### Clustering
# Cluster herarquico y trasformación de los datos

# Por distancia euclídea
EU_dist = RX_multiplotDendo(finalData,
                            dir = "lr",
                            method = "euclidean",
                            factor = "Tissue",
                            colorColumn = "Group",
                            colorPal = color,
                            colorOutColumn = "Group",
                            colorOutPal = color,
                            leaves = TRUE,
                            shapeColumn = "Gender",
                            leavesShapes = c(21,22),
                            colorLegend = "none",
                            colorOutLegend = "Grupo",
                            shapeLegend = "Sexo",
                            multiplot = TRUE, 
                            wrap = TRUE,
                            labelSize = 3.5,
                            expandY = -0.05,
                            leavesSize = 3,
                            leavesStroke = 1,
                            expandYlbs = -0.03,
                            moveLabel = 0
                            ) 

# Por correlación
Corr = RX_multiplotDendo(finalData,
                         dir = "rl",
                         method = "correlation",
                         factor = "Tissue",
                         colorColumn = "Group",
                         colorPal = color,
                         colorOutColumn = "Group",
                         colorOutPal = color,
                         leaves = TRUE,
                         shapeColumn = "Gender",
                         leavesShapes = c(21,22),
                         colorLegend = "none",
                         colorOutLegend = "Grupo",
                         shapeLegend = "Sexo",
                         multiplot = TRUE, 
                         wrap = TRUE,
                         labelSize = 3.5,
                         expandY = -0.05,
                         leavesSize = 3,
                         leavesStroke = 1,
                         expandYlbs = -0.03,
                         moveLabel = 0
                         )     

Con = lapply(seq(levels(phenoData$Tissue)), 
             function(x) RX_DendoRelations(EU_dist$Data[[x]],
                                           Corr$Data[[x]],
                                           size = c(0.15,10,0)))

Pltlist = list(EU_dist$Plot[[1]], Con[[1]], Corr$Plot[[1]])


DendoPlot = ggarrange(plotlist = Pltlist,common.legend = TRUE,
                      widths=c(1.0, 0.5, 1.0), ncol = 3, nrow = 1,
                      #labels = c("A","", "B"),
                      legend = "right", label.x = 0.02) 

# Guardamos
ggsave(DendoPlot, device = "svg", 
       filename = glue("{DirPlot}/{Acc}finalHC.svg"),
       height = (nSTis * nTis)/4 , width = 12)

# Mostramos
DendoPlot  
```    


```{r echo=T, eval=doShow, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=6, fig.width=12, fig.cap=" _**Figura :** Clustering jerárquico de la muestras del estudio GSE205668, las muestras están agrupadas en base a su condición médica por colors, mientras que la intensidad de color denota el sexo. Este cluster se ha llevado a  cabo tanto en base a la correlación entre las muestras (B), como en base a la distancia euclídea (A)._"}  

knitr::include_graphics(glue("{DirPlot}/{Acc}finalHC.svg"))

``` 

&nbsp;   

***      

&nbsp;    



## Anotación {.tabset .tabset-fade -}   


```{r echo=T, eval=loadData, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=14}
RX_table <- function(Data,
                     Color1 = "#007FA6",
                     Color2 = "#007FA6" ,
                     Color.l = "black" ,
                     Color.l2 = "#878787",
                     Color.up = "#CB326D",
                     Color.down = "#00AFBB",
                     footer = NULL,
                     header,
                     cols,
                     cols_keys,
                     font = "Calibri" #,  hline = FALSE
                     ){
  
  ## Flextable
  # Set info
  ft <- flextable(Data, col_keys = colnames(Data))
  # Set header
  ft <- set_header_df(ft, mapping = header, key = "col_keys" )
  # Format number
  ft <- colformat_num(ft, big.mark = ".", decimal.mark = "," )
  # Set footer
  if(! is.null(footer)){
    ft <- add_footer(ft, values = footer) %>% 
      merge_h(part = "footer")  %>% 
      bold(j=1, part = "footer") %>%
      hline(border = fp_border(width = 2, color = Color1), part = "footer")
  }
  
  # Merge headers
  ft <- merge_h(ft, part = "header") %>% 
    merge_v( part = "header")
  
  # Merge contrastes
  #ft <- merge_v(ft, j = c(1,2), part = "body")
  
  # Horizontal lines
  'if (isTRUE(hline)){
    ft <- hline(ft, i=seq(from=3, to=nrow(Data), by=3),
                border = fp_border(width = 1, color = Color.l2),
                part="body")
    }'
  ft <- hline(ft,border = fp_border(width = 2, color = Color1), part = "header")
  
  # Outer bottom
  ft <- hline_bottom(ft, border = fp_border(width = 2, color = Color1))
  
  # Alineamiento
  ft <- flextable::align(ft, i=1, align = "center", part = "header") %>%
    flextable::align(i=2, align = "right", part = "header")
  ft <- flextable::align(ft, align = "right", part = "footer")
  ft <- flextable::align(ft, j=1, align = "left", part = "footer")
  
  
  # Header design
  ft <- fontsize(ft, i = 1:2, size = 12, part = "header") %>%
    color(i=1, color = Color2, part = "header") %>%
    color(i=2, color = Color.l2, part = "header") %>%
    bold(i=1, bold = TRUE, part = "header")
  # Rotate names
  #ft <- rotate(ft, i = 2, rotation = "btlr", part = "header", align = "bottom")
  
  # Font
  #font(ft, fontname = font, part = "all")
  
  # Matriz de colores
  colormatrix <- ifelse(Data[, cols] == 0, Color.l2, Color.l )
  # Color
  ft <- color(ft, j=cols, color = colormatrix, part = "body") 
  # Color
  x = Data[, 1]
  colors = case_when(
    x == "Up" ~ Color.up,
    x == "Down" ~ Color.down,
    TRUE ~ Color.l
  )
  ft <- color(ft, j=1, color = colors, part = "body") %>%
    bold(j=1, bold = TRUE, part = "body")

  return(ft)
}
```


```{r echo=T, eval=doAnot, message=FALSE, warning=FALSE, fig.align = centrado, results = 'hide', out.width="98%"}

Estudios = c("E_MEXP_1425",
             "GSE2508",
             "GSE20950",
             "GSE29718", 
             "GSE64567", 
             "GSE92405",
             "GSE141432",
             "GSE205668")
Plataforma = c("Affymetrix GeneChip Human Genome U133 Plus 2.0 [HG-U133_Plus_2]",
               "[HG_U95Av2] Affymetrix Human Genome U95 Version 2 Array
[HG_U95A] Affymetrix Human Genome U95A Array
[HG_U95B] Affymetrix Human Genome U95B Array
[HG_U95C] Affymetrix Human Genome U95C Array
[HG_U95D] Affymetrix Human Genome U95D Array
[HG_U95E] Affymetrix Human Genome U95E Array",
               "[HG-U133_Plus_2] Affymetrix Human Genome U133 Plus 2.0 Array",
               "[HuGene-1_0-st] Affymetrix Human Gene 1.0 ST Array [transcript (gene) version]",
               "Illumina HumanHT-12 V4.0 expression beadchip",
"[HG-U133_Plus_2] Affymetrix Human Genome U133 Plus 2.0 Array [CDF: Brainarray HGU133Plus2_Hs_ENTREZG_v18]",
               "Illumina NextSeq 500 (Homo sapiens)",
               "Illumina HiSeq 2500 (Homo sapiens)"
               )
Paquete = c("hgu133plus2.db",
            "hgu95av2.db \n
            hgu95a.db \n
            hgu95b.db \n
            hgu95c.db \n
            hgu95d.db \n
            hgu95e.db \n",
            "hgu133plus2.db",
            "hugene10sttranscriptcluster.db",
            "illuminaHumanv4.db", 
            "hgu133plus2.db",
            "org.Hs.eg.db",
            "org.Hs.eg.db") 
Origen = c("Bioconductor",
           "Bioconductor",
           "Bioconductor",
           "Bioconductor",
           "Bioconductor", 
           "Bioconductor",
           "Bioconductor",
           "Bioconductor"
           )
normDatas = glue("{Estudios}_rawData")
Counts0 = sapply(normDatas, function(x) nrow(get(x)))
AnotDatas = glue("{Estudios}_finalData")
Counts1 = sapply(AnotDatas, function(x) nrow(get(x)))

Data = data.frame(Estudios,
                  Plataforma,
                  Paquete,
                  Origen,
                  "Pre-anotación" = Counts0,
                  "Post-anotación" = Counts1,
                  row.names = Estudios,
                  check.names = FALSE
                  )


cols=colnames(Data)[-c(1)] # Columns with info
col_keys = colnames(Data) # Nombres unicos de las columnas
# Header
header = data.frame(col_keys = col_keys,
                    H1 = c(col_keys[c(1:4)], "Nº de genes", "Nº de genes"),
                    H2 = col_keys
                    )
#%>% width( width = 1.2, unit = "in")
#datatable(AnotResume, options = list(caption = "Resumen de la anotacion"))

```    

```{r echo=T, eval=doAnot, message=FALSE, warning=FALSE}
RX_table(Data, header = header, cols = cols, cols_keys = col_keys) %>%
  hline( border = fp_border(width = 1, color = "#878787"), part="body") %>%
  hline_bottom(border = fp_border(width = 2, color = "#007FA6"))

```

&nbsp;      


*Resumen anotaciones*  

```{r echo=T, eval=doAnot2, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=14, fig.cap=" _**Figura :** UpSet plot resumen de las anotaciones de los estudios._"}

ColorList = c("#cef587", "#90C432", "#2494b5","#03556e"  )
ColorPal <- colorRampPalette(ColorList)
Estudios = c("E_MEXP_1425",
             "GSE2508",
             "GSE20950",
             "GSE29718", 
             "GSE64567", 
             "GSE92405",
             "GSE141432",
             "GSE205668")
colores = ColorPal(length(Estudios))
AnotDatas = glue("{Estudios}_finalData")
MinSize = 10
An = sapply(AnotDatas, function(x) RX_ifelse(class(get(x))== "ExpressionSet",
                                             fData(get(x))$ENTREZID,
                                             rowData(get(x))$ENTREZID))
# Cuantos son unicos
IDs = unlist(An)
length(which(table(IDs) == 1))

An = list_to_matrix(An)
colnames(An) = Estudios
Data = data.frame(An)

# Leyenda:
#Anots = as.data.frame(make_comb_mat(An)) 
#Leg = sapply(as.list(Anots), function(x) colnames(Data)[which(x == 1)], simplify = FALSE)
Inter = upset_data(Data,colnames(Data), min_size = MinSize)
Inter= str_split(names(Inter$sizes$exclusive_intersection), pattern = "-")
Leyenda = lapply(Inter, function(x) upset_query(intersect= x,
                                                color=colores[length(x)],
                                                fill=colores[length(x)],
                                                only_components=c('intersections_matrix', 'Intersection size')))

UpsetPlot <- upset(Data, colnames(Data), name = "Intersecciones", guides = "keep",
                   # Numero de interacciones minimas 
                   min_size = 10,
    width_ratio=0.16,
    stripes='transparent',
    matrix = intersection_matrix(
            geom=geom_point(
                shape='square',
                size=5,
                stroke = 1
            ), 
            segment=geom_segment(
              size= 1.2
            ),
            outline_color=list(
                active='black',
                inactive='gray'
            )) #+ theme(text=element_text(size = 29,angle=0))
    ,
    # Asignacion de colores
     queries= Leyenda, 
    # Set sizes
    set_sizes = upset_set_size(position='right') 
    # Numero de conteos
    + geom_text(aes(label=..count..), hjust=1.1, stat='count', color="white")
        + ylab('Nº de genes anotados') + theme(axis.text.x=element_text(size = 10,
                                                                  angle=0),
                                               text = element_text(size=15),
                                         panel.grid.minor = element_blank(),
                                         panel.grid.major = element_blank(),
                                         axis.line.x = element_line(color="black"),
                                         axis.ticks = element_line(color="black")),
    # Interactions
    base_annotations = list(
        'Intersection size'=( 
            intersection_size(
              mapping=aes(fill='black'),
              text = list(
                vjust=0.5,
                hjust=-0.2,
                angle=90,
                size =4.5
            ), 
            text_colors=c(
                on_background='black', on_bar='white'
            )
            ) #+ scale_fill_manual(values=c('bars_color'='blue'))   
            + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(),
               plot.background = element_rect(fill="transparent",
                                                   color = "transparent"),
          panel.background = element_rect(fill = "transparent",
                                          color = "transparent"),
          axis.line.y = element_line(color="black"),
          axis.text.y=element_text(size = 10, angle=0)
          #axis.line.x = element_line(color="black"),
          #axis.ticks = element_line(color="black")
          )
            + ylab('Anotaciones por grupo')
        )), 
    themes=upset_modify_themes(
        list(
            'intersections_matrix'=theme(text=element_text(size=12)),
            'Intersection size'=theme(text=element_text(size=15)) )
        ) 
) 

# Guardamos
ggsave(UpsetPlot, device = "svg", 
       filename = glue("{DirPlots}/UpsetPlot_norm_anot.svg"),height = 8, width = 12)

UpsetPlot
```  


```{r echo=F, eval=F, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=14}
# https://krassowski.github.io/complex-upset/articles/Examples_Python.html#themes
# https://krassowski.github.io/complex-upset/articles/Examples_R.html
```  

```{r echo=T, eval=doShow,  warning=FALSE, fig.align = centrado, fig.height=8, fig.width=12, fig.cap=" _**Figura :** UpSet plot resumen de las anotaciones de los estudios._"} 

knitr::include_graphics(glue("{DirPlots}/UpsetPlot_norm_anot.svg"))

```

&nbsp;   

***      

&nbsp;  


## Agrupación {.tabset .tabset-fade -}   


```{r echo=T, eval=loadData, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=14}
Estudios = c("E_MEXP_1425",
             "GSE20950",
             "GSE29718", 
             "GSE64567", 
             "GSE92405",
             "GSE141432",
             "GSE205668") 

phenoDatas = lapply(glue("{Estudios}_finalData"), 
                    function(x) data.frame(RX_ifelse(class(get(x)) == "SummarizedExperiment",
                                colData(get(x)),
                                pData(get(x))))[,c(1:9)]) 
names(phenoDatas) = Estudios

pD = do.call(rbind, phenoDatas)
```


```{r echo=T, eval=loadData, message=FALSE, warning=FALSE, out.align = centrado, results = 'hide'}
# Creamos una tabla con la información de todos
Groups = c("Np_IS", "Ob_IS", "Ob_IR")
Tissues = levels(pD$Tissue)

DT = sapply( Tissues, function(Tissue)
  sapply(Estudios, function(x)
    sapply(Groups, function(grupo)
      sum(unfactor(phenoDatas[[x]][which(phenoDatas[[x]]$Tissue == Tissue),"Group"]) == grupo),
      USE.NAMES = TRUE),
    USE.NAMES = TRUE),
  simplify = FALSE, USE.NAMES = TRUE)

DT2 = sapply(Tissues, function(i)
  data.frame(Tissue = i, Group = rownames(DT[[i]]), DT[[i]]),
  simplify = FALSE, USE.NAMES = TRUE)

DT3 = do.call("rbind", DT2) 

'datatable(DT3, rownames = NULL) %>% formatStyle("Tissue", target = "row", 
                                                backgroundColor = styleEqual(c("SAT", "VAT", "lSAT"), c('#A8DB47', '#E295F2', "#CFCFC8")))'
Data <- DT3 %>% separate(col=Group,
                 into= c("Obesidad", "Diabetes"),
                 sep = "_")
```

```{r echo=T, eval=loadData, message=FALSE, warning=FALSE, out.align = centrado, out.width="98%"}
cols=colnames(Data)[-c(1)] # Columns with info
col_keys = colnames(Data) # Nombres únicos de las columnas
# Header
header = data.frame(col_keys = col_keys,
                    H1 = c(col_keys[c(1,2,3)], rep("Estudios", length(Estudios))),
                    H2 = col_keys
                    )
RX_table(Data, header = header, cols = cols, cols_keys = col_keys) %>%
  merge_v( j = c(1,2), part = "body") %>%
  hline(i=seq(from=3, to=nrow(Data)-1, by=3),
                border = fp_border(width = 1, color = "#878787"),
                part="body") %>%
  hline_bottom(border = fp_border(width = 2, color = "#007FA6"))

```
   



```{r echo=T, eval=doRes, message=FALSE, warning=FALSE, fig.align = centrado, fig.height=8, fig.width=12, fig.cap=" _**Figura :** Resumen del número de muestras por grupo y genero que componen todos los estudios._"}  

BarPlot <- RX_resumeBarPlot(data.frame(pD),
                            Fac_1 = "Group",
                            Fac_2 = "Gender",
                            Fac_wrap = "Tissue",
                            expandY= 0.1,
                            OneBar = TRUE,
                            colors = colors,
                            xlab = "Grupo",
                            Fac_1_tit = "Grupo",
                            Fac_2_tit = "Sexo",
                            sep_width = 0.8,
                            porcentLabels = FALSE,
                            alpha = alpha0)  

# Guardamos
ggsave(BarPlot, device = "svg",
       filename = glue("{DirPlots}/ResumeBarPlot.svg"),
       height = 8, width = 12)

BarPlot

```  


```{r echo=T, eval=doShow,  warning=FALSE, fig.align = centrado, fig.height=5, fig.width=12, fig.cap=" _**Figura :** UpSet plot resumen de las anotaciones de los estudios._"} 

knitr::include_graphics(glue("{DirPlots}/ResumeBarPlot.svg"))

```



&nbsp;   

***      

&nbsp;  


